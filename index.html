<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ZÃ¡rate Cien - Control Maestro</title>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js" async defer></script>
    <style>
        :root { --primary: #2563eb; --success: #16a34a; --warning: #f59e0b; --bg: #f8fafc; --text: #1e293b; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 15px; }
        .card { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 20px; }
        h1 { font-size: 1.5rem; text-align: center; color: var(--primary); margin-top: 0; }
        
        .contador-box { padding: 12px; border-radius: 10px; text-align: center; font-weight: bold; margin-bottom: 15px; display: none; }
        .contador-pendiente { background: #fee2e2; color: #b91c1c; border: 1px solid #fecaca; }
        .contador-listo { background: #dcfce7; color: #15803d; border: 1px solid #bbf7d0; }

        .btn-google { background: #4285F4; color: white; border: none; padding: 12px; border-radius: 10px; font-weight: bold; width: 100%; cursor: pointer; margin-bottom: 15px; }
        .evento-sugerido { background: #fff; padding: 12px; border-radius: 10px; margin-bottom: 8px; cursor: pointer; border-left: 5px solid #4285F4; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .evento-cobrado { border-left-color: var(--success); opacity: 0.5; background: #f1f5f9; cursor: default; }

        .form-group { margin-bottom: 12px; }
        label { display: block; font-size: 0.85rem; font-weight: 600; margin-bottom: 5px; color: #64748b; }
        select, input { width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 16px; box-sizing: border-box; outline: none; }
        
        button { width: 100%; padding: 15px; border-radius: 10px; border: none; font-size: 1rem; font-weight: bold; cursor: pointer; color: white; }
        .btn-add { background: var(--primary); margin-top: 10px; }
        .btn-corte { background: var(--warning); margin-top: 25px; }
        .btn-clear { background: #ef4444; font-size: 0.8rem; padding: 8px; margin-top: 15px; opacity: 0.6; }
        
        .item-registro { background: #fff; padding: 12px; border-radius: 10px; margin-bottom: 10px; border-left: 5px solid var(--primary); box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        #mensajeExito { display: none; background: var(--success); color: white; text-align: center; padding: 10px; border-radius: 10px; margin-bottom: 10px; position: sticky; top: 10px; z-index: 100; }
    </style>
</head>
<body>

<div id="mensajeExito">âœ… Â¡Cobro Registrado correctamente!</div>

<div class="card">
    <h1>ZÃ¡rate Cien</h1>
    
    <button class="btn-google" id="btn_login" onclick="handleAuthClick()">ðŸ”— Sincronizar Calendario</button>

    <div id="contador_pendientes" class="contador-box"></div>

    <div id="seccion_eventos" style="display:none;">
        <div id="lista_eventos_google"></div>
    </div>

    <hr style="margin: 20px 0; border: 0; border-top: 1px solid #eee;">

    <div class="form-group">
        <label>Lugar</label>
        <select id="area">
            <option>Consultorio 1</option>
            <option>Consultorio 2</option>
            <option>Espejos</option>
            <option>JardÃ­n</option>
            <option>Tiendita</option>
        </select>
    </div>
    <div class="form-group">
        <label>Fecha y Hora</label>
        <input type="datetime-local" id="fechaHora">
    </div>
    <div class="form-group">
        <label>Concepto (Cliente)</label>
        <input type="text" id="concepto" placeholder="Toca un evento o escribe aquÃ­">
    </div>
    <div class="form-group">
        <label>Nota (Opcional)</label>
        <input type="text" id="nota" placeholder="Detalles extra...">
    </div>
    <div class="form-group">
        <label>Monto ($)</label>
        <input type="number" id="monto" placeholder="0.00">
    </div>
    <button class="btn-add" onclick="registrarFinal()">âœ… REGISTRAR COBRO</button>
</div>

<div style="font-weight: bold; color: #64748b; margin: 20px 0 10px 5px;">Movimientos del DÃ­a:</div>
<div id="contenedorRegistros"></div>

<button class="btn-corte" onclick="validarCorte()">ðŸ’° REALIZAR CORTE DE CAJA</button>
<button class="btn-clear" onclick="limpiarTodo()">Borrar historial manualmente</button>

<script>
    // --- CONFIGURACIÃ“N DE GOOGLE (PEGA TUS LLAVES AQUÃ) ---
    const CLIENT_ID = 'TU_ID_DE_CLIENTE.apps.googleusercontent.com';
    const API_KEY = 'TU_CLAVE_DE_API_AQUÃ';
    const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest';
    const SCOPES = 'https://www.googleapis.com/auth/calendar.readonly';

    let tokenClient;
    let gapiInited = false;
    let gisInited = false;
    let registros = JSON.parse(localStorage.getItem('zarate_datos')) || [];
    let eventosCobrados = JSON.parse(localStorage.getItem('eventos_cobrados')) || [];
    let eventoActualId = null;
    let totalEventosHoy = 0; 

    // 1. InicializaciÃ³n de LibrerÃ­as
    window.onload = () => {
        actualizarFecha();
        actualizarInterfaz();
        
        // Cargar GAPI
        gapi.load('client', async () => {
            await gapi.client.init({ apiKey: API_KEY, discoveryDocs: [DISCOVERY_DOC] });
            gapiInited = true;
        });

        // Cargar GIS (Google Identity Services)
        tokenClient = google.accounts.oauth2.initTokenClient({
            client_id: CLIENT_ID,
            scope: SCOPES,
            callback: '', // Se define dinÃ¡micamente
        });
        gisInited = true;
    };

    // 2. FunciÃ³n de AutenticaciÃ³n (Ahora definida en window para evitar errores)
    window.handleAuthClick = function() {
        if (!gisInited || !gapiInited) {
            alert("Las herramientas de Google aÃºn estÃ¡n cargando. Espera un segundo.");
            return;
        }

        tokenClient.callback = async (resp) => {
            if (resp.error !== undefined) throw (resp);
            document.getElementById('seccion_eventos').style.